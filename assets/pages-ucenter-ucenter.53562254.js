import{J as e,M as s,p as t,K as i,l as n,r as o,o as a,c as l,w as r,b as d,h as c,t as u,e as h,f as g,F as _,n as f,j as p,k as m,i as y,T as I}from"./index.8a89d12b.js";import{_ as k}from"./uni-icons.41c57c15.js";import{r as w}from"./uni-app.es.42fcfc95.js";import{_ as C}from"./uni-popup.344f4fa2.js";import{_ as L}from"./plugin-vue_export-helper.21dcd24c.js";import{_ as b}from"./cloud-image.09eb42e1.js";import{s as v}from"./store.e01ffa37.js";const x="RewardedVideo",F="FullScreenVideo";const A="csj";class ${constructor(e,s={}){this._isLoad=!1,this._isLoading=!1,this._lastLoadTime=0,this._lastError=null,this._retryCount=0,this._loadCallback=null,this._closeCallback=null,this._errorCallback=null;const t=this._ad=e;t.onLoad((e=>{this._isLoading=!1,this._isLoad=!0,this._lastLoadTime=Date.now(),this.onLoad()})),t.onClose((e=>{this._isLoad=!1,this.onClose(e)})),t.onVerify&&t.onVerify((e=>{})),t.onError((({code:e,message:s})=>{this._isLoading=!1;const t={code:e,errMsg:s};if(-5008!==e){if(this._retryCount<1)return this._retryCount+=1,void this._loadAd();this._lastError=t,this.onError(t)}else this._loadAd()}))}get isExpired(){return 0!==this._lastLoadTime&&Math.abs(Date.now()-this._lastLoadTime)>18e5}get isLoading(){return this._isLoading}getProvider(){return this._ad.getProvider()}load(e,s){this._loadCallback=e,this._errorCallback=s,this._isLoading||(this._isLoad?this.onLoad():(this._retryCount=0,this._loadAd()))}show(e){if(this._closeCallback=e,this._isLoading||!this._isLoad)return;if(null!==this._lastError)return void this.onError(this._lastError);this.getProvider()===A&&this.isExpired?this._loadAd():this._ad.show()}onLoad(e){null!=this._loadCallback&&this._loadCallback()}onClose(e){null!=this._closeCallback&&this._closeCallback({isEnded:e.isEnded})}onError(e){null!=this._errorCallback&&this._errorCallback(e)}destroy(){this._ad.destroy()}_loadAd(){this._isLoad=!1,this._isLoading=!0,this._lastError=null,this._ad.load()}}class E extends ${constructor(e={}){super(plus.ad.createRewardedVideoAd(e),e)}}class S extends ${constructor(e={}){super(plus.ad.createFullScreenVideoAd(e),e)}}var R=new class{constructor(){this._ads={}}load(e,s,t){let i=this._fixOldOptions(e),{adpid:n}=i;n&&!this.isBusy(n)&&this.get(i).load(s,t)}show(t,i,n){let o=this._fixOldOptions(t),{adpid:a}=o;if(a){e({mask:!0});var l=this.get(o);l.load((()=>{s(),l.show((e=>{i&&i(e)}))}),(e=>{s(),n&&n(e)}))}}isBusy(e){return this._ads[e]&&this._ads[e].isLoading}get(e){const{adpid:s,singleton:t=!0}=e;return!1===t&&this._ads[s]&&(this._ads[s].destroy(),delete this._ads[s]),delete e.singleton,this._ads[s]||(this._ads[s]=this._createAdInstance(e)),this._ads[s]}_createAdInstance(e){const s=e.adType||x;delete e.adType;let t=null;return s===x?t=new E(e):s===F&&(t=new S(e)),t}_fixOldOptions(e){return"string"==typeof e?{adpid:e}:e}};const T=t.database().action("signIn").collection("opendb-sign-in");new Date((new Date).toLocaleDateString()).getTime();var D=L({name:"uni-signIn",data:()=>({total:0,scores:0,weekdays:[1,2,3,4,5,6,7],signInRes:{days:[],n:0}}),mounted(){},methods:{async getSignedInInfo(e="今日已签过"){const s=new Date((new Date).toLocaleDateString()).getTime();let t=await T.where(`'user_id' == $env.uid && 'date' == ${s} && 'isDelete' == false`).get();return t.result.data.length&&(this.signInRes=t.result,this.$refs.popup.open(),i({title:e,duration:3e3,icon:"none"})),t.result.data},async showRewardedVideoAd(){let o=await this.getSignedInInfo();if(console.log(o),o&&0==o.length){let o=t.getCurrentUserInfo().uid;if(!o)return n({url:"/pages/ucenter/login-page/index/index"});R.show({adpid:1733738477,adType:"RewardedVideo",urlCallback:{userId:o,extra:"uniSignIn"}},(t=>{if(t&&t.isEnded){console.log("onClose "+t.isEnded);let n=0;e({mask:!0});let o=setInterval((async e=>{n++,t=await this.getSignedInInfo("签到成功"),(n>2||t.length)&&(t.length||i({title:"签到失败！",icon:"error",duration:6e3}),clearInterval(o),s())}),2e3)}else console.log("onClose "+t.isEnded),i({title:"播放中途退出,签到失败！",icon:"error",duration:5e3})}),(e=>{console.log(e),i({title:e.errMsg,icon:"none"})}))}},async open(){e({mask:!0});try{let e=await this.getSignedInInfo();if(e&&0==e.length){let e=await T.add({});console.log(e),s(),this.signInRes=e.result,this.$refs.popup.open(),7==this.signInRes.days.length?i({title:"你已完成7日连续签到，获得60积分！",icon:"none",duration:5e3}):i({title:"签到成功,获得10积分！",icon:"none",duration:5e3})}}catch(t){s(),console.error(t)}},closeMe(e){this.$refs.popup.close()}}},[["render",function(e,s,t,i,n,I){const L=p,b=m,v=y,x=w(o("uni-icons"),k),F=w(o("uni-popup"),C);return a(),l(v,null,{default:r((()=>[d(F,{ref:"popup",type:"center"},{default:r((()=>[d(L,{class:"background-img",src:"./assets/background.42813c32.png",mode:"width"}),d(v,{class:"content"},{default:r((()=>[d(v,{class:"main"},{default:r((()=>[d(b,{class:"title"},{default:r((()=>[c("今日签到成功")])),_:1}),d(b,{class:"total"},{default:r((()=>[c("本轮已签到"+u(n.signInRes.days.length)+"天",1)])),_:1}),d(b,{class:"scores"},{default:r((()=>[c("当前积分："+u(n.signInRes.score),1)])),_:1})])),_:1}),d(v,null,{default:r((()=>[d(v,{class:"days-box"},{default:r((()=>[(a(!0),h(_,null,g(n.weekdays,((e,s)=>(a(),l(v,{class:"days",key:s},{default:r((()=>[n.signInRes.days.includes(e-1)?(a(),l(x,{key:0,class:"icon active",color:"#FFFFFF",type:"checkmarkempty"})):(a(),h(_,{key:1},[e<n.signInRes.n?(a(),l(x,{key:0,class:"icon active",color:"#FFFFFF",type:"closeempty"})):(a(),l(x,{key:1,class:"icon",type:"checkmarkempty",color:"#FFFFFF"}))],64)),n.signInRes.days.includes(e-1)||e>n.signInRes.n?(a(),l(b,{key:2,class:f(["day",{grey:e>n.signInRes.n}])},{default:r((()=>[c("第"+u(e)+"天",1)])),_:2},1032,["class"])):(a(),l(b,{key:3,class:"day"},{default:r((()=>[c("缺卡")])),_:1}))])),_:2},1024)))),128))])),_:1}),d(v,{class:"tip-box"},{default:r((()=>[d(b,{class:"tip"},{default:r((()=>[c("签到一次得10积分")])),_:1}),d(v,{class:"row"},{default:r((()=>[d(b,{class:"tip"},{default:r((()=>[c("连续签到7天可多得")])),_:1}),d(b,{class:"red"},{default:r((()=>[c("50")])),_:1}),d(b,{class:"tip"},{default:r((()=>[c("积分")])),_:1})])),_:1})])),_:1})])),_:1}),d(x,{onClick:I.closeMe,class:"close-icon",type:"closeempty",size:"20",color:"#AAAAAA"},null,8,["onClick"])])),_:1})])),_:1},512)])),_:1})}],["__scopeId","data-v-df586558"]]);const V=t.database();var j=L({data(){return{gridList:[{text:this.$t("mine.showText"),icon:"chat"},{text:this.$t("mine.showText"),icon:"cloud-upload"},{text:this.$t("mine.showText"),icon:"contact"},{text:this.$t("mine.showText"),icon:"download"}],ucenterList:[[{title:this.$t("mine.about"),to:"/pages/ucenter/about/about",icon:"info"}]],listStyles:{height:"150rpx",width:"150rpx",border:{color:"#eee",width:"1px",style:"solid",radius:"100%"}}}},onLoad(){},onShow(){},computed:{userInfo:()=>v.userInfo,hasLogin:()=>v.hasLogin,appConfig:()=>I().globalData.config},methods:{toSettings(){n({url:"/pages/ucenter/settings/settings"})},signIn(){this.$refs.signIn.open()},signInByAd(){this.$refs.signIn.showRewardedVideoAd()},ucenterListClick(e){!e.to&&e.event&&this[e.event]()},async checkVersion(){let e=await new Promise(((e,s)=>{s({message:"请在App中使用"})}));console.log(e),e.result.code>0||i({title:e.result.message,icon:"none"})},toUserInfo(){n({url:"/uni_modules/uni-id-pages/pages/userinfo/userinfo"})},tapGrid(e){i({title:this.$t("mine.clicked")+" "+(e+1),icon:"none"})},gotoMarket(){},getScore(){if(!this.userInfo)return i({title:this.$t("mine.checkScore"),icon:"none"});e({mask:!0}),V.collection("uni-id-scores").where('"user_id" == $env.uid').field("score,balance").orderBy("create_date","desc").limit(1).get().then((e=>{console.log(e);const s=e.result.data[0];let t="";t=s?this.$t("mine.currentScore")+s.balance:this.$t("mine.noScore"),i({title:t,icon:"none"})})).finally((()=>{s()}))},async share(){let{result:e}=await V.collection("uni-id-users").where("'_id' == $cloudEnv_uid").field("my_invite_code").get(),s=e.data[0].my_invite_code;if(!s)return i({title:"请检查uni-config-center中uni-id配置，是否已启用 autoSetInviteCode",icon:"none"});console.log({myInviteCode:s}),this.appConfig.about}}},[["render",function(e,s,t,i,n,h){const g=w(o("uni-sign-in"),D),_=w(o("cloud-image"),b),f=p,I=m,k=y;return a(),l(k,{class:"center"},{default:r((()=>[d(g,{ref:"signIn"},null,512),d(k,{class:"userInfo",onClickCapture:h.toUserInfo},{default:r((()=>[h.hasLogin&&h.userInfo.avatar_file&&h.userInfo.avatar_file.url?(a(),l(_,{key:0,width:"150rpx",height:"150rpx",src:h.userInfo.avatar_file.url},null,8,["src"])):(a(),l(f,{key:1,class:"logo-img",src:"./assets/defaultAvatarUrl.80fc747f.png"})),d(k,{class:"logo-title"},{default:r((()=>[h.hasLogin?(a(),l(I,{key:0,class:"uer-name"},{default:r((()=>[c(u(h.userInfo.nickname||h.userInfo.username||h.userInfo.mobile),1)])),_:1})):(a(),l(I,{key:1,class:"uer-name"},{default:r((()=>[c(u(e.$t("mine.notLogged")),1)])),_:1}))])),_:1})])),_:1},8,["onClickCapture"])])),_:1})}],["__scopeId","data-v-5c26c200"]]);export{j as default};
