var e=Object.defineProperty,t=Object.defineProperties,i=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,a=(t,i,o)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[i]=o;import{p as l,a9 as r,a2 as u,a1 as c,X as g,l as p,K as d,J as f,M as h,av as m,L as y,o as b,c as v,w,b as x,e as _,f as C,h as S,t as k,F as T,j as B,k as U,i as I}from"./index.8a89d12b.js";import{m as O}from"./store.e01ffa37.js";import{_ as j}from"./plugin-vue_export-helper.21dcd24c.js";l.database().collection("uni-id-users");var P=j({computed:{agreements(){if(!r.agreements)return[];let{serviceUrl:e,privacyUrl:t}=r.agreements;return[{url:e,title:"用户服务协议"},{url:t,title:"隐私政策条款"}]},agree:{get(){return this.getParentComponent().agree},set(e){return console.log("setAgree",e),this.getParentComponent().agree=e}}},data:()=>({servicesList:[{id:"username",text:"账号登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/user.png",path:"/uni_modules/uni-id-pages/pages/login/login-withpwd"},{id:"smsCode",text:"短信验证码",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/sms.png",path:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd?type=smsCode"},{id:"weixin",text:"微信登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/weixin.png"},{id:"apple",text:"苹果登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/apple.png"},{id:"univerify",text:"一键登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/univerify.png"},{id:"taobao",text:"淘宝登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/taobao.png"},{id:"facebook",text:"脸书登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/facebook.png"},{id:"alipay",text:"支付宝登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/alipay.png"},{id:"qq",text:"QQ登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/qq.png"},{id:"google",text:"谷歌登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/google.png"},{id:"douyin",text:"抖音登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/douyin.png"},{id:"sinaweibo",text:"新浪微博",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/sinaweibo.png"}],univerifyStyle:{fullScreen:!0,backgroundColor:"#ffffff",buttons:{iconWidth:"45px",list:[]},privacyTerms:{defaultCheckBoxState:!1,textColor:"#BBBBBB",termsColor:"#5496E3",prefix:"我已阅读并同意",suffix:"并使用本机号码登录",privacyItems:[]}}}),watch:{agree(e){this.univerifyStyle.privacyTerms.defaultCheckBoxState=e}},async created(){let e=this.servicesList,t=r.loginTypes;e=e.filter((e=>"apple"!=e.id&&t.includes(e.id))),t.includes("univerify")&&(this.univerifyStyle.privacyTerms.privacyItems=this.agreements,e.forEach((({id:e,logo:t,path:i})=>{"univerify"!=e&&this.univerifyStyle.buttons.list.push({iconPath:t,provider:e,path:i})}))),this.servicesList=e.filter((e=>(e.path?e.path.split("?")[0]:"")!=this.getRoute(1)))},methods:{getParentComponent(){return this.$parent.$parent},setUserInfo(e){console.log("setUserInfo",e)},getRoute(e=0){let t=u();return e>t.length?"":"/"+t[t.length-e].route},navigateTo(e){if(this.getRoute(1)==e.split("?")[0]&&"/uni_modules/uni-id-pages/pages/login/login-withoutpwd"==this.getRoute(1)){let t=e.split("?")[1].split("=")[1];c("uni-id-pages-set-login-type",t)}else this.getRoute(2)==e?g():this.getRoute(1)!=e?p({url:e,animationType:"slide-in-left",complete(e){}}):console.log("出乎意料的情况,path："+e)},async login_before(e,t=!0,i={}){var o,n;if(console.log(e),["qq","xiaomi","sinaweibo","taobao","facebook","google","alipay","douyin"].includes(e))return d({title:"该登录方式暂未实现，欢迎提交pr",icon:"none"});if(["univerify","apple"].includes(e))return d({title:"当前设备不支持此登录，请选择其他登录方式",icon:"none"});console.log(e,this.agree);let s=((null==(n=null==(o=r)?void 0:o.agreements)?void 0:n.scope)||[]).includes("register");if(console.log({needAgreements:s}),"univerify"!=e&&s&&!this.agree){return this.getParentComponent().$refs.agreements.popup((()=>{console.log(e,t),this.login_before(e,t,i)}))}if("weixin"==e){let e=location.protocol+"//"+document.domain+(window.location.href.includes("#")?"/#":"")+"/uni_modules/uni-id-pages/pages/login/login-withoutpwd?is_weixin_redirect=true&type=weixin";return console.log("redirectUrl----",e),"micromessenger"==window.navigator.userAgent.toLowerCase().match(/MicroMessenger/i)?window.open(`https://open.weixin.qq.com/connect/oauth2/authorize?\n\t\t\t\t\t\t\t\t\t\tappid=${r.appid.weixin.h5}\n\t\t\t\t\t\t\t\t\t\t&redirect_uri=${encodeURIComponent(e)}\n\t\t\t\t\t\t\t\t\t\t&response_type=code\n\t\t\t\t\t\t\t\t\t\t&scope=snsapi_userinfo\n\t\t\t\t\t\t\t\t\t\t&state=STATE&connect_redirect=1#wechat_redirect`):location.href=`https://open.weixin.qq.com/connect/qrconnect?appid=${r.appid.weixin.web}\n\t\t\t\t\t\t\t\t\t\t\t&redirect_uri=${encodeURIComponent(e)}\n\t\t\t\t\t\t\t\t\t\t\t&response_type=code&scope=snsapi_login&state=STATE#wechat_redirect`}if(f({mask:!0}),"univerify"==e){let e=function(){h(),t.close(),t.offButtonsClick(i)},t=uni.getUniverifyManager(),i=async t=>{console.log("点击了第三方登录，provider：",t,t.provider,this.univerifyStyle.buttons.list);let i=(await uni.getCheckBoxState())[1].state;this.agree=i;let{path:o}=this.univerifyStyle.buttons.list[t.index];o?(this.navigateTo(o),e()):i?(e(),setTimeout((()=>{this.login_before(t.provider)}),500)):d({title:"你未同意隐私政策协议",icon:"none"})};return t.onButtonsClick(i),t.login({univerifyStyle:this.univerifyStyle,success:e=>{console.log("login success",e),this.login(e.authResult,"univerify")},fail(e){d({title:JSON.stringify(e),icon:"none"})},complete:async e=>{console.log(e),h(),this.agree=(await uni.getCheckBoxState())[1].state,t.offButtonsClick(i)}})}if("weixinMobile"===e)return this.login({phoneCode:i.phoneNumberCode},e);m({provider:e,onlyAuthorize:!0,success:async t=>{if(console.log(t),"apple"==e){let e=await this.getUserInfo({provider:"apple"});Object.assign(t.authResult,e.userInfo),h()}this.login("weixin"==e?{code:t.code}:t.authResult,e)},fail:async e=>{console.log(e),h()}})},login(e,t){console.log("执行登录开始----"),console.log({params:e,type:t});let i="loginBy"+t.trim().replace(t[0],t[0].toUpperCase());l.importObject("uni-id-co",{customUI:!0})[i](e).then((e=>{console.log("login-result",e),d({title:"登录成功",icon:"none"}),e.loginType=t,O.loginSuccess(e)})).catch((e=>{console.log(e),y({content:e.message,confirmText:"知道了",showCancel:!1})})).finally((e=>{"univerify"==t&&uni.closeAuthView(),h()}))},doUserProfileNext(){try{O.loginSuccess()}catch(e){console.log(e)}},getUserInfo:async e=>new Promise(((l,r)=>{var u;uni.getUserInfo((u=((e,t)=>{for(var i in t||(t={}))n.call(t,i)&&a(e,i,t[i]);if(o)for(var i of o(t))s.call(t,i)&&a(e,i,t[i]);return e})({},e),t(u,i({success:e=>{l(e)},fail:e=>{y({content:JSON.stringify(e),showCancel:!1}),r(e)}}))))}))}},[["render",function(e,t,i,o,n,s){const a=B,l=U,r=I;return b(),v(r,null,{default:w((()=>[x(r,{class:"fab-login-box"},{default:w((()=>[(b(!0),_(T,null,C(n.servicesList,((e,t)=>(b(),v(r,{class:"item",key:t,onClick:t=>e.path?s.navigateTo(e.path):s.login_before(e.id,!1)},{default:w((()=>[x(a,{class:"logo",src:e.logo,mode:"scaleToFill"},null,8,["src"]),x(l,{class:"login-title"},{default:w((()=>[S(k(e.text),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1})}],["__scopeId","data-v-e6ebff60"]]);export{P as _};
