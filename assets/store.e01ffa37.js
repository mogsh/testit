import{p as e,R as o,_ as s,K as n,$ as t,W as i,V as a,v as r,a0 as l,a1 as u,a2 as c,u as d,X as g}from"./index.8a89d12b.js";const f=e.importObject("uni-id-co"),h=e.database().collection("uni-id-users");let p=o("uni-id-pages-userInfo")||{};console.log(p);const I={userInfo:p,hasLogin:0!=Object.keys(p).length};console.log("data",I);const w={async updateUserInfo(e=!1){if(e)h.where("_id==$env.uid").update(e).then((o=>{console.log(o),o.result.updated?(n({title:"更新成功",icon:"none"}),this.setUserInfo(e)):n({title:"没有改变",icon:"none"})}));else try{let e=await h.where("'_id' == $cloudEnv_uid").field("mobile,nickname,username,email,avatar_file").get();console.log("fromDbData",e.result.data),this.setUserInfo(e.result.data[0])}catch(o){this.setUserInfo({},{cover:!0}),console.error(o.message,o.errCode)}},async setUserInfo(e,{cover:o}={cover:!1}){console.log("set-userInfo",e);let s=o?e:Object.assign(m.userInfo,e);return m.userInfo=Object.assign({},s),m.hasLogin=0!=Object.keys(m.userInfo).length,console.log("store.userInfo",m.userInfo),t({key:"uni-id-pages-userInfo",data:m.userInfo}),e},async logout(){var e,o;await f.logout(),i("uni_id_token"),a("uni_id_token_expired",0),r({url:`/${null!=(o=null==(e=l.uniIdRouter)?void 0:e.loginPage)?o:"uni_modules/uni-id-pages/pages/login/login-withoutpwd"}`}),u("uni-id-pages-logout"),this.setUserInfo({},{cover:!0})},loginSuccess(e={}){const{showToast:o=!0,toastText:s="登录成功",autoBack:t=!0,uniIdRedirectUrl:i=""}=e;if(console.log({toastText:s,autoBack:t}),o&&n({title:s,icon:"none"}),this.updateUserInfo(),u("uni-id-pages-login-success"),t){let o=0,s=c();if(s.forEach(((e,n)=>{"login"==s[s.length-n-1].route.split("/")[3]&&o++})),i)return d({url:i});if("weixin"==e.loginType)return console.log("window.history",window.history),window.history.go(-3);if(o){const e=l.pages[0];return d({url:`/${e.path}`})}g({delta:o})}}},m=s(I);export{w as m,m as s};
