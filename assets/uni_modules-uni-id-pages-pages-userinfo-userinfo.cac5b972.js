import{g as e,l as i,ap as o,J as s,p as t,M as n,r as a,o as l,c,w as u,a as r,n as d,i as p,av as h,b as g,h as f,k as m,ae as y,K as b,d as _,e as w,F as k}from"./index.8a89d12b.js";import{_ as v}from"./cloud-image.09eb42e1.js";import{r as I}from"./uni-app.es.42fcfc95.js";import{_ as C}from"./uni-icons.41c57c15.js";import{s as x,m as M}from"./store.e01ffa37.js";import{_ as P}from"./plugin-vue_export-helper.21dcd24c.js";import{a as S,_ as B}from"./uni-list.ff4adee6.js";import{_ as j}from"./uni-popup-dialog.07617231.js";import{_ as L}from"./uni-popup.344f4fa2.js";var T=P({data:()=>({isPC:!1}),props:{width:{type:String,default:()=>"50px"},height:{type:String,default:()=>"50px"},border:{type:Boolean,default:()=>!1}},async mounted(){this.isPC=!["ios","android"].includes(e().platform),console.log(" this.isPC",this.isPC,e().platform)},computed:{hasLogin:()=>x.hasLogin,userInfo:()=>x.userInfo,avatar_file:()=>x.userInfo.avatar_file},methods:{setAvatarFile(e){M.updateUserInfo({avatar_file:e})},uploadAvatarImg(e){if(console.log(this.hasLogin),!this.hasLogin)return i({url:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd"});const a={quality:100,width:600,height:600,resize:!0};o({count:1,crop:a,success:async e=>{console.log(e);let o=e.tempFiles[0],l={extname:o.name.split(".")[o.name.split(".").length-1]},c=e.tempFilePaths[0];this.isPC||(c=await new Promise((e=>{i({url:"/uni_modules/uni-id-pages/pages/userinfo/cropImage/cropImage?path="+c+`&options=${JSON.stringify(a)}`,animationType:"fade-in",events:{success:i=>{e(i)}},complete(e){console.log(e)}})}))),console.log(this.userInfo);let u=this.userInfo._id+""+Date.now();l.name=u,s({title:"更新中",mask:!0});let{fileID:r}=await t.uploadFile({filePath:c,cloudPath:u,fileType:"image"});l.url=r,console.log({avatar_file:l}),n(),this.setAvatarFile(l)}})}}},[["render",function(e,i,o,s,t,n){const h=I(a("cloud-image"),v),g=I(a("uni-icons"),C),f=p;return l(),c(f,{onClick:n.uploadAvatarImg,class:d(["box",{showBorder:o.border}]),style:r({width:o.width,height:o.height,lineHeight:o.height})},{default:u((()=>[n.avatar_file?(l(),c(h,{key:0,src:n.avatar_file.url,width:o.width,height:o.height},null,8,["src","width","height"])):(l(),c(g,{key:1,style:r({width:o.width,height:o.height,lineHeight:o.height}),class:"chooseAvatar",type:"plusempty",size:"30",color:"#dddddd"},null,8,["style"]))])),_:1},8,["onClick","class","style"])}],["__scopeId","data-v-21fe9151"]]);t.database().collection("uni-id-users");const A=t.importObject("uni-id-co");var U=P({emits:["success"],computed:{},data:()=>({}),methods:{beforeGetphonenumber:async()=>await new Promise(((e,i)=>{s({mask:!0}),wx.checkSession({success(){console.log("session_key 未过期"),e(),n()},fail(){console.log("session_key 已经失效，正在执行更新"),h({success({code:o}){t.importObject("uni-id-co",{customUI:!0}).loginByWeixin({code:o}).then((i=>{console.log(i),e()})).catch((e=>{console.log(e),i()})).finally((e=>{console.log(e),n()}))},fail:e=>{console.error(e),i()}})}})})),async bindMobileByMpWeixin(e){console.log(e),"getPhoneNumber:ok"==e.detail.errMsg?(console.log(e.detail),await this.beforeGetphonenumber(),A.bindMobileByMpWeixin(e.detail).then((e=>{console.log(e),this.$emit("success")})).finally((e=>{this.closeMe()}))):this.closeMe()},async open(){this.$refs.popup.open()},closeMe(e){this.$refs.popup.close()}}},[["render",function(e,i,o,s,t,n){const r=m,d=y,h=p,b=I(a("uni-popup"),L);return l(),c(b,{ref:"popup",type:"bottom"},{default:u((()=>[g(h,{class:"box"},{default:u((()=>[g(r,{class:"headBox"},{default:u((()=>[f("绑定资料")])),_:1}),g(r,{class:"tip"},{default:u((()=>[f("将一键获取你的手机号码绑定你的个人资料")])),_:1}),g(h,{class:"btnBox"},{default:u((()=>[g(r,{onClick:n.closeMe,class:"close"},{default:u((()=>[f("关闭")])),_:1},8,["onClick"]),g(d,{class:"agree uni-btn",type:"primary","open-type":"getPhoneNumber",onGetphonenumber:n.bindMobileByMpWeixin},{default:u((()=>[f("获取")])),_:1},8,["onGetphonenumber"])])),_:1})])),_:1})])),_:1},512)}],["__scopeId","data-v-2750d0e2"]]);t.database().collection("uni-id-users");const F=t.importObject("uni-id-co");var N=P({computed:{userInfo:()=>x.userInfo},data:()=>({univerifyStyle:{authButton:{title:"本机号码一键绑定"},otherLoginButton:{title:"其他号码绑定"}},hasPwd:!1,showLoginManage:!1}),async onShow(){this.univerifyStyle.authButton.title="本机号码一键绑定",this.univerifyStyle.otherLoginButton.title="其他号码绑定"},async onLoad(e){e.showLoginManage&&(this.showLoginManage=!0);let i=await F.getAccountInfo();this.hasPwd=i.isPasswordSet},methods:{login(){i({url:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd",complete:e=>{console.log(e)}})},logout(){M.logout()},bindMobileSuccess(){M.updateUserInfo()},changePassword(){i({url:"/uni_modules/uni-id-pages/pages/userinfo/change_pwd/change_pwd",complete:e=>{console.log(e)}})},bindMobile(){this.bindMobileBySmsCode()},univerify(){h({provider:"univerify",univerifyStyle:this.univerifyStyle,success:async e=>{console.log(e.authResult),F.bindMobileByUniverify(e.authResult).then((e=>{console.log(e),M.updateUserInfo()})).catch((e=>{console.log(e)})).finally((e=>{console.log(e),uni.closeAuthView()}))},fail:e=>{console.log(e),"30002"!=e.code&&"30001"!=e.code||this.bindMobileBySmsCode()}})},bindMobileBySmsCode(){i({url:"./bind-mobile/bind-mobile"})},setNickname(e){console.log(e),e?(M.updateUserInfo({nickname:e}),this.$refs.dialog.close()):this.$refs.dialog.open()},deactivate(){i({url:"/uni_modules/uni-id-pages/pages/userinfo/deactivate/deactivate"})},async bindThirdAccount(e){const i=t.importObject("uni-id-co"),o={weixin:"wx_openid",alipay:"ali_openid",apple:"apple_openid",qq:"qq_openid"}[e.toLowerCase()];this.userInfo[o]?(await i["unbind"+e](),await M.updateUserInfo()):h({provider:e.toLowerCase(),onlyAuthorize:!0,success:async o=>{const s=await i["bind"+e]({code:o.code});s.errCode&&b({title:s.errMsg||"绑定失败"}),await M.updateUserInfo()},fail:async e=>{console.log(e),n()}})}}},[["render",function(e,i,o,s,t,n){const r=I(a("uni-id-pages-avatar"),T),d=p,h=I(a("uni-list-item"),S),m=I(a("uni-list"),B),b=I(a("uni-popup-dialog"),j),v=I(a("uni-popup"),L),C=I(a("uni-id-pages-bind-mobile"),U),x=y;return l(),c(d,{class:"uni-content"},{default:u((()=>[g(d,{class:"avatar"},{default:u((()=>[g(r,{width:"260rpx",height:"260rpx"})])),_:1}),g(m,null,{default:u((()=>[g(h,{class:"item",onClick:i[0]||(i[0]=e=>n.setNickname("")),title:"昵称",rightText:n.userInfo.nickname||"未设置",link:""},null,8,["rightText"]),g(h,{class:"item",onClick:n.bindMobile,title:"手机号",rightText:n.userInfo.mobile||"未绑定",link:""},null,8,["onClick","rightText"]),n.userInfo.email?(l(),c(h,{key:0,class:"item",title:"电子邮箱",rightText:n.userInfo.email},null,8,["rightText"])):_("",!0),t.hasPwd?(l(),c(h,{key:1,class:"item",onClick:n.changePassword,title:"修改密码",link:""},null,8,["onClick"])):_("",!0)])),_:1}),g(m,{class:"mt10"},{default:u((()=>[g(h,{onClick:n.deactivate,title:"注销账号",link:"navigateTo"},null,8,["onClick"])])),_:1}),g(v,{ref:"dialog",type:"dialog"},{default:u((()=>[g(b,{mode:"input",value:n.userInfo.nickname,onConfirm:n.setNickname,title:"设置昵称",placeholder:"请输入要设置的昵称"},null,8,["value","onConfirm"])])),_:1},512),g(C,{ref:"bind-mobile-by-sms",onSuccess:n.bindMobileSuccess},null,8,["onSuccess"]),t.showLoginManage?(l(),w(k,{key:0},[n.userInfo._id?(l(),c(x,{key:0,onClick:n.logout},{default:u((()=>[f("退出登录")])),_:1},8,["onClick"])):(l(),c(x,{key:1,onClick:n.login},{default:u((()=>[f("去登录")])),_:1},8,["onClick"]))],64)):_("",!0)])),_:1})}],["__scopeId","data-v-323461d8"]]);export{N as default};
