<!DOCTYPE html >
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
    <meta http-equiv="description" content="This is my page">
    <meta http-equiv="Cache-Control" content="max-age=300" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="format-detection" content="email=no"/>
    <title>望舌问膳</title>
    <link rel="stylesheet" href="./css/index.css?v=1.0.1">
    <script src="./js/jackyViewport.js"></script>
    <script src="https://static.8guess.com/js/zepto.min.js"></script>
    <link rel="stylesheet" href="https://static.8guess.com/js/swiper.min.css">
</head>

<body>

<!---->
<div class="blank-view"></div>

<!-- tab -->
<div flex="main:left cross:center" class="tab">
    <div flex="dir:top main:center cross:center" class="tab-item">
        <img src="./images/tab2on.png" alt="">
        <span style="color:#3d6fff">食谱</span>
    </div>
    <a flex="dir:top main:center cross:center" class="tab-item" href="./regimen.html">
        <img src="./images/tab3.png" alt="">
        <span>养生</span>
    </a>
</div>

<!-- tabBar -->
<div id="tabbar-view">
    <!--tabBar模板-->
    <script type="text/template" id="tabBar">
        {{if arrLen(tabList)<=4}}
        <div flex="main:left cross:center" class="tabbar">
            {{each tabList as item index}}
            <div class="tabbar-for click-tab" flex="main:center cross:center" data-index="{{index}}"
                 data-id="{{item.id}}">
                <div class="tabbar-item ">
                    {{item.cname}}
                </div>
            </div>
            {{/each}}
        </div>
        {{else}}
        <!-- length>4 -->
        <div flex="main:left cross:center" class="tabbar-long">
            {{each tabList as item index}}
            <div class="tabbar-for-long click-tab" flex="main:center cross:center" data-index="{{index}}"
                 data-id="{{item.id}}">
                <div class="tabbar-item">
                    {{item.cname}}
                </div>
            </div>
            {{/each}}
        </div>
        {{/if}}
    </script>
</div>

<!-- Banner -->
<div class="swiper-container" id="swiperContainer">
    <div class="swiper-wrapper" id="swiperWrapper">
        <!--swiper模板-->
        <script type="text/template" id="swiperBanner">
            {{each swiperList as item index}}
            <div class="swiper-slide swiper-item">
                <img class="swiper-img" src="{{item.img}}">
            </div>
            {{/each}}
        </script>
    </div>
    <!-- Add Pagination -->
    <div class="swiper-pagination"></div>
</div>

<!-- 体质选择 -->
<div flex="main:justify cross:center" class="filter" id="filter">
    <div id="physique">全部体质</div>
    <i class="iconfont  icon-xiangyou icon-down"></i>
</div>

<!-- 体质选择弹窗 -->
<div class="picker-view" id="picker-view">
    <div flex="main:justify cross:center" class="picker-op">
        <div flex="main:center cross:center" class="cancel" id="cancel">取消</div>
        <div flex="main:center cross:center" class="sure" id="sure">确定</div>
    </div>
    <div class="picker">
        <div class="physique-swiper">
            <div class="physique-swiper-item physique-swiper-item-on">全部体质</div>
            <div class="physique-swiper-item">阴虚体质</div>
            <div class="physique-swiper-item">气郁体质</div>
            <div class="physique-swiper-item">淤血体质</div>
            <div class="physique-swiper-item">湿热体质</div>
            <div class="physique-swiper-item">痰湿体质</div>
            <div class="physique-swiper-item">阳虚体质</div>
            <div class="physique-swiper-item">气虚体质</div>
            <div class="physique-swiper-item">平和体质</div>
        </div>
    </div>
</div>

<!-- food -->
<div flex="main:justify cross:center" class="food-view flex-wrap" id="foodListView"></div>
<!--食谱列表模版 -->
<script type="text/template" id="foodList">
    {{each foodList as item index}}
    <div flex="dir:top main:justify cross:center" class="food click-food" data-id="{{item.id}}">
        <div class="physique">{{item.physique}}</div>
        <img src="{{item.bannerUrl}}" class="image" alt="">
        <div class="title">{{item.cname}}</div>
        <div class="tag ell2">{{item.effect}}</div>
    </div>
    {{/each}}
</script>

<!-- 到底了 -->
<div class="no-more">—— 没有更多了 ——</div>

<div class="blank-view"></div>
</body>

</html>

<script type="text/javascript" src="https://static.8guess.com/js/swiper.min.js"></script>
<script type="text/javascript" src="https://static.8guess.com/js/template.js"></script>
<script src="./js/jacky.js"></script>
<script src="./js/base.js"></script>
<script type="text/javascript">
    var page = {
        preCate: 0,
        pickPhysique: "",
        moreLoading: true,//加载数据中
        foodParams: {
            physique: "",
            pageSize: 20,
            pageNum: 1,
            cid: ''
        }
    }

    Jacky.util.landscape({color: '#e02e24'});

    $(function () {
        console.debug(111, history)
        console.debug(111, document.referrer)
        init()
        // 滚动加载数据
        $(window).scroll(function () {
            var b = $(window).scrollTop(),
                c = $(document).height() - $(window).height()
            if (c - b < 300 && !page.moreLoading) {
                closeLoad()
                console.debug('加载中...')
                page.foodParams.pageNum += 1
                getFood()
            }
        });

    });

    function init() {
        // 获取分类
        getCate()
        // 获取Banner
        getBanner()
    }

    // 获取分类
    function getCate() {
        $.ajax({
            url: config.baseUrl + "/tongue/intf/tongue/getCookBookCates.jsp",
            type: "POST",
            success: function (res) {
                console.debug('类目==', res)
                var data = res.data
                var html = template('tabBar', {tabList: data})
                $("#tabbar-view").append(html);
                $('.tabbar-item').first().addClass('tabbar-item-on')
                page.foodParams.cid = data[0].id
                getFood()
            }
        });
    }

    // 获取Banner
    function getBanner() {
        $.ajax({
            url: config.baseUrl + "/tongue/intf/tongue/getMaterials.jsp",
            type: "POST",
            data: {adsenseId: "A00107d3755e7c614afaab80bd74e388f3c6"},
            success: function (res) {
                console.debug('Banner==', res)
                var data = res.data
                var html = template('swiperBanner', {swiperList: data});
                $("#swiperWrapper").append(html);
                var banner = new Swiper('#swiperContainer', {
                    loop: 4000,
                    autoplay: true,
                    pagination: {
                        el: '.swiper-pagination',
                    },
                    lazy: {
                        loadPrevNext: true,
                    }
                });
            }
        });
    }

    // 获取食谱
    function getFood() {
        Jacky.util.pageLoad.show();
        $.ajax({
            url: config.baseUrl + "/tongue/intf/tongue/getCookBooks.jsp",
            type: "POST",
            data: page.foodParams,
            success: function (res) {
                console.debug('食谱==', res)
                Jacky.util.pageLoad.remove();
                var data = res.data
                if (res.data.length > 0) {
                    openLoad()
                    var html = template('foodList', {foodList: data});
                    $("#foodListView").append(html);
                } else {
                    $('.no-more').show()
                    page.foodParams.pageNum -= 1
                }
            }
        });
    }


    // 切换tabbar
    $('#tabbar-view .click-tab').live('click', function (e) {
        if (page.preCate == $(this).attr("data-index")) {
            return 0;
        }

        console.debug($(this).attr("data-index"), $(this).attr("data-id"))
        page.preCate = $(this).attr("data-index")
        page.foodParams.cid = $(this).attr("data-id")
        $(this).find('.tabbar-item').addClass('tabbar-item-on')
        $(this).siblings().find('.tabbar-item').removeClass('tabbar-item-on')

        $('.no-more').hide()
        openLoad()
        $("#foodListView").empty()
        getFood()
    })

    // 查看详情
    $('#foodListView .click-food').live('click', function (e) {
        window.location.href = './foodInfo.html?id=' + $(this).attr("data-id")
    })

    // 打开选择体质弹窗
    $('#filter').on('click', function () {
        $('#picker-view').show()
    })

    // 选择体质
    $('.physique-swiper-item').on('click', function (e) {
        console.debug($(this).text())
        if ($(this).text() == '全部体质') {
            page.pickPhysique = ''
        } else {
            page.pickPhysique = $(this).text()
        }
        $(this).addClass('physique-swiper-item-on').siblings().removeClass('physique-swiper-item-on')
    })

    // 取消选择
    $('#cancel').on('click', function () {
        $('#picker-view').hide()
    })


    // 确定选择
    $('#sure').on('click', function () {
        page.foodParams.physique = page.pickPhysique
        $('#physique').text(page.foodParams.physique)
        $('#picker-view').hide()
        $('.no-more').hide()
        openLoad()
        $("#foodListView").empty()
        getFood()
    })

    // 开启加载更多
    function openLoad() {
        page.moreLoading = false
    }

    // 关闭加载更多
    function closeLoad() {
        page.moreLoading = true
    }


</script>
